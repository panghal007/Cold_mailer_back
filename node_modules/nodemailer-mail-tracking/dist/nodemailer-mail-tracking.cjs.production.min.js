"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=e(require("p-map")),n=require("cheerio"),t=e(require("jsonwebtoken")),o=e(require("express"));function i(){return(i=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e}).apply(this,arguments)}function u(e,r){try{var n=e()}catch(e){return r(e)}return n&&n.then?n.then(void 0,r):n}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var c=["to","cc","bcc"],a=function(e){return Array.isArray(e)?e.join(", "):e};function s(e){return"string"==typeof e?e:Array.isArray(e)?e.map((function(e){return"string"==typeof e?e:e.address||void 0})).filter((function(e){return Boolean(e)})):(null==e?void 0:e.address)?e.address:void 0}var f=function(e,r){return t.sign(i({},r),e.jwtSecret,{expiresIn:"1y"})},l=function(e,r){try{return t.verify(r,e.jwtSecret)}catch(e){var n=new Error("JwtDecodeError");throw n.name="JwtDecodeError",n}};function v(e){return e&&"name"in e&&"JwtDecodeError"===e.name}var d=function(e,r,t){return function(e,r,t){var o=n.load(r);return o("a").each((function(r,n){var u=o(n).attr("href");if(u&&u.startsWith("http")){var c=i({},t,{link:u}),a=f(e,c);o(n).attr("href",e.baseUrl+"/link/"+encodeURI(a))}})),o.html()}(e,function(e,r,n){var t=f(e,n),o='<img src="'+e.baseUrl+"/blank-image/"+encodeURI(t)+'"'+(e.imageAlt?' alt="'+e.imageAlt+'"':"")+" />";return new RegExp(/<\/body>/).test(r)?r.replace(/<\/body>/,o+"</body>"):""+r+o}(e,r,t),t).trim()};exports.expressApp=function(e){var r=o(),n=function(){return Promise.resolve("function"==typeof e?e():e)};return r.get("/link/:jwt",(function(e,r,t){try{var o=u((function(){return Promise.resolve(n()).then((function(n){var t=l(n,e.params.jwt);return Promise.resolve(n.onLinkClick(t)).then((function(){r.redirect(t.link)}))}))}),(function(e){v(e)?t():t(e)}));return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}})),r.get("/blank-image/:jwt",(function(e,r,t){try{var o=u((function(){return Promise.resolve(n()).then((function(n){var t=l(n,e.params.jwt);return Promise.resolve(n.onBlankImageView(t)).then((function(){r.set("Content-Type","image/svg+xml"),r.send('<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"/>')}))}))}),(function(e){v(e)?t():t(e)}));return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}})),r},exports.sendMail=function(e,n,t){try{var o=function(o){if(f)return o;var l=function(e,r){return function(e){return c.map((function(r){return e[r]})).map((function(r){return function(e,r){var n=r.to,t=r.cc,o=r.bcc,u=function(e,r){if(null==e)return{};var n,t,o={},i=Object.keys(e);for(t=0;t<i.length;t++)r.indexOf(n=i[t])>=0||(o[n]=e[n]);return o}(r,["to","cc","bcc"]),c={},f=s(n);f&&(c.To=a(f));var l=s(t);l&&(c.Cc=a(l));var v=s(o);v&&(c.Bcc=a(v));var d,m=s(u.from);return((void 0===(d=s(e))||Array.isArray(d)?d:[d])||[]).map((function(e){return i({},u,{headers:i({},u.headers,c),envelope:{from:Array.isArray(m)?m[0]:m,to:e}})}))}(r,e)})).flat().filter((function(e){return Boolean(e)}))}(r).map((function(r){var n,t,o={recipient:"object"==typeof r.envelope.to?r.envelope.to.address:(n=r.envelope.to,t=n.match(/([a-zA-Z0-9._-]+[d+1]?[a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi),t&&t[0]||"")},u=i({},e.getData(o),o);return i({},r,{html:d(e,r.html,u)})}))}(e,t);return r(l,(function(r){return Promise.resolve(u((function(){function t(){return Promise.resolve(n.sendMail(r)).then((function(e){return{result:e,sendOptions:r}}))}var o=function(){if(e.getSendOptionsBeforeSend)return Promise.resolve(e.getSendOptionsBeforeSend(r)).then((function(e){r=e}))}();return o&&o.then?o.then(t):t()}),(function(e){return{error:e,sendOptions:r}})))}),{concurrency:e.sendConcurrency||Infinity})},f=!1,l=function(){if(!(r=t).html||"string"!=typeof r.html)return u((function(){function r(){return Promise.resolve(n.sendMail(t)).then((function(e){return f=!0,[{result:e,sendOptions:t}]}))}var o=function(){if(e.getSendOptionsBeforeSend)return Promise.resolve(e.getSendOptionsBeforeSend(t)).then((function(e){t=e}))}();return o&&o.then?o.then(r):r()}),(function(e){return f=!0,[{error:e,sendOptions:t}]}));var r}();return Promise.resolve(l&&l.then?l.then(o):o(l))}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=nodemailer-mail-tracking.cjs.production.min.js.map
